// @ts-check

import path from 'path'
import { fileURLToPath } from 'url'

import * as config from './config.js'

import { utils, initialize } from '@neptunemutual/sdk'
import { ethers } from 'ethers'
import { saveToDiskRaw } from '../src/util/io.js'

const __dirname = fileURLToPath(new URL('.', import.meta.url))

// SELECT chain_id, cover_key, product_key FROM cover.product_created
// ORDER BY chain_id, cover_key, product_key;

const products = [
  // run above query on both mainnet and testnet
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x616176652d763300000000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x62616e636f722d76330000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x636f6d706f756e642d7632000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x636f6e7665782d76310000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x647964782d763300000000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x676d782d76310000000000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x6f6e65696e63682d763200000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x7375736869737761702d76310000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x756e69737761702d763300000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x616176652d763200000000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x62616c616e6365722d7632000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x63757276652d7632000000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x676e6f7369732d736166652d7631000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x6d616b65722d7631000000000000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x73796e7468657469782d76320000000000000000000000000000000000000000' },
  { chainId: 1, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x756e69737761702d763200000000000000000000000000000000000000000000' },
  { chainId: 56, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x616c706163612d76310000000000000000000000000000000000000000000000' },
  { chainId: 56, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x646f646f2d763200000000000000000000000000000000000000000000000000' },
  { chainId: 56, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x6f6e65696e63682d763200000000000000000000000000000000000000000000' },
  { chainId: 56, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x70616e63616b65737761702d7632000000000000000000000000000000000000' },
  { chainId: 56, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x756e69737761702d763300000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x616176652d763300000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x62616e636f722d76330000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x636f6d706f756e642d7632000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x636f6d706f756e642d7633000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x636f6e7665782d76310000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x647964782d763300000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x676d782d76310000000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x676d782d76320000000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x6f6e65696e63682d763200000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x6f6e65696e63682d763300000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x7375736869737761702d76310000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x7375736869737761702d76330000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x706f70756c61722d646566692d61707073000000000000000000000000000000', productKey: '0x756e69737761702d763300000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x616176652d763200000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x616176652d76322d616e642d7633000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x62616c616e6365722d7632000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x63757276652d7632000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x676e6f7369732d736166652d7631000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x6d616b65722d7631000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x736166652d763100000000000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x73796e7468657469782d76320000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x756e69737761702d763200000000000000000000000000000000000000000000' },
  { chainId: 42161, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x756e69737761702d76322d616e642d7633000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x31696e63682d7632000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x636f6d706f756e642d7632000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x636f6e7665782d76310000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x6b79626572737761702d76310000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x6c69646f2d763100000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x6e657875732d6d757475616c2d76310000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x72706c2d76310000000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x73757368692d7632000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x6465666900000000000000000000000000000000000000000000000000000000', productKey: '0x756e69737761702d763300000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x616176652d763200000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x62616c616e6365722d7632000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x63757276652d7632000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x676e6f7369732d736166652d7631000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x6d616b65722d7631000000000000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x73796e7468657469782d76320000000000000000000000000000000000000000' },
  { chainId: 43113, coverKey: '0x7072696d65000000000000000000000000000000000000000000000000000000', productKey: '0x756e69737761702d763200000000000000000000000000000000000000000000' }
]

initialize({ store: config.store })

const selectStatements = []
let maxValueLengthTillNow = 0

const getCoverProductData = async (chainId, coverKey, productKey) => {
  const rpc = config.rpcs[chainId]
  const provider = new ethers.providers.JsonRpcProvider(rpc)

  console.log('Fetching', chainId, ethers.utils.parseBytes32String(coverKey), ethers.utils.parseBytes32String(productKey))

  const data = await utils.store.readStorage(chainId, [
    {
      returns: 'bool',
      property: 'isValidProduct',
      fn: 'getBool',
      args: [
        ethers.utils.solidityKeccak256(
          ['bytes32', 'bytes32', 'bytes32'],
          [utils.keyUtil.PROTOCOL.NS.COVER_PRODUCT, coverKey, productKey]
        )
      ]
    },
    {
      returns: 'string',
      property: 'info',
      fn: 'getString',
      args: [
        ethers.utils.solidityKeccak256(
          ['bytes32', 'bytes32', 'bytes32'],
          [utils.keyUtil.PROTOCOL.NS.COVER_PRODUCT, coverKey, productKey]
        )
      ]
    },
    {
      returns: 'bool',
      property: 'requiresWhitelist',
      fn: 'getBool',
      args: [
        ethers.utils.solidityKeccak256(
          ['bytes32', 'bytes32', 'bytes32'],
          [utils.keyUtil.PROTOCOL.NS.COVER_REQUIRES_WHITELIST, coverKey, productKey]
        )
      ]
    },
    {
      returns: 'uint256',
      property: 'isActiveProduct',
      fn: 'getUint',
      args: [
        ethers.utils.solidityKeccak256(
          ['bytes32', 'bytes32', 'bytes32'],
          [utils.keyUtil.PROTOCOL.NS.COVER_PRODUCT, coverKey, productKey]
        )
      ]
    },
    {
      returns: 'uint256',
      property: 'capital_efficiency',
      fn: 'getUint',
      args: [
        ethers.utils.solidityKeccak256(
          ['bytes32', 'bytes32', 'bytes32'],
          [utils.keyUtil.PROTOCOL.NS.COVER_PRODUCT_EFFICIENCY, coverKey, productKey]
        )
      ]
    }
  ], provider)

  if (!data.isValidProduct) {
    return null
  }

  const values = [
    { columnName: 'chain_id', value: chainId },
    { columnName: 'cover_key', value: `string_to_bytes32('${ethers.utils.parseBytes32String(coverKey)}')` },
    { columnName: 'product_key', value: `string_to_bytes32('${ethers.utils.parseBytes32String(productKey)}')` },
    { columnName: 'capital_efficiency', value: data.capital_efficiency.toNumber() }
  ]

  const maxValueLength = values.map(x => String(x.value).length + 2).reduce((prev, len) => len > prev ? len : prev, 0)
  const maxLengthToUse = maxValueLengthTillNow > maxValueLength ? maxValueLengthTillNow : maxValueLength
  maxValueLengthTillNow = maxLengthToUse

  const query = [
    'SELECT',
    values.map(val => `  ${String(val.value).padEnd(maxLengthToUse, ' ')} AS ${val.columnName}`).join(',\n')
  ]

  return (query.join('\n'))
}

export async function updateProductConfigView () {
  for (let i = 0; i < products.length; i++) {
    const { chainId, coverKey, productKey } = products[i]
    try {
      const st = await getCoverProductData(chainId, coverKey, productKey)

      if (!st) {
        console.error(Error('Invalid product'))
        continue
      }
      selectStatements.push(st)
    } catch (error) {
      console.error('Error: %s %s', chainId, coverKey, error)
    }
  }

  const content = (
`CREATE OR REPLACE VIEW config_product_view
AS
${selectStatements.join('\nUNION ALL\n')};\n`
  )

  saveToDiskRaw(path.resolve(__dirname, '../sql/base/001-config/0.config_product_view.sql'), content)
}
